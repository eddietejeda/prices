<!DOCTYPE html>
<html>
<head>
  <title>Coop Food Prices</title>

  <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.0.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.0.0/lodash.min.js"></script>
</head>
<body>
<h1>Food prices</h1>

<select id="products"></select>
<div id="chart"></div>

<h2>Getting cheaper</h2>
<div id="cheaper"></div>

<h2>Getting pricier</h2>
<div id="pricier"></div>

<script type="text/template" id="changes">
  <div class="change">
    <% _.each(rows, function(row){ %>
      <div>
      <%= row.name %>
      <%= row.units %>
      <%= row.new_price %> (<%= row.price_diff %> from <%= row.old_price%>, <%= row.pcg_change.toFixed(0) %>%)
      </div>
    <% }); %>
  </div>
</script>



<script type="text/javascript">
  $(function() {
    var $container = $('#chart');
    var $select = $('#products');

    //https://gist.github.com/rcackerman/55b8ff81a72482b981a9

    var types = $.get('http://104.131.168.178:3389/sql?query=select distinct name, units from coop order by name asc');
    var origins = $.get("http://104.131.168.178:3389/sql?query=select origin, date_trunc('day', date), count(*) from coop group by date_trunc('day', date), origin order by origin asc");
    var kales =  $.get("http://104.131.168.178:3389/sql?query=select * from coop where LOWER(name) LIKE '%25kale%25' order by date asc");

    var index = $.get("http://104.131.168.178:3389/sql?query= with prices as (   select     new.name,     new.units,     old_price,     new_price,     new_price::float - old_price::float as price_diff,     (old_price %2B new_price)/2.0 as price_avg   from (     select name, units, price as old_price     from coop where date = current_date - '7 days'::interval   ) old   join (     select name, units, price as new_price     from coop where date = (select max(date) from coop)   ) new     on old.name = new.name     and old.units = new.units )  select   *,   price_diff/price_avg * 100 as pcg_change from prices order by price_diff;");

    index.done(function(data) {
      data = data.data;
      console.log("index", data);

      var template = _.template($('#changes').html());
      $('#cheaper').html(template({ rows: data.rows.slice(0, 10) }));
      $('#pricier').html(template({ rows: _.reverse(data.rows).slice(0, 10) }));

    });

    function chartTimePrice(data, options) {
      console.log("Charting with", data);
      $container.highcharts({
        title: {
          text: options.title
        },
        xAxis: {
          type: 'datetime',
          labels: {
            format: '{value:%d %b}'
          }
        },
        yAxis: {
          title: {
            text: 'Price'
          },
          labels: {
            format: '${value:,.2f}'
          },
          min: 0,
          max: 7
        },
        legend: {
            enabled: false
        },
        tooltip: {
            headerFormat: '<b>{series.name}</b><br>',
            pointFormat: '{point.x:%Y-%m-%d}: ${point.y:.2f}'
        },
        series: [{
          type: 'spline',
          name: options.name,
          data: data
        }]
      });
    }

    function prep(data, options) {
      var series = [];
      console.log(data);
      _.each(data.data.rows, function(row) {
        var date = new Date(row.date);
        date.setDate(date.getDate() + 1); // Add one day... timezone mess.
        series.push([date.getTime(), row.price]);
      });
      chartTimePrice(series, options);
    }

    types.done(function(data) {
      _.each(data.data.rows, function(row) {
        $select.append('<option value="" data-name="' + row.name + '" data-units="' + row.units + '">' + row.name + '</option>');
      });

      $select.on('change', function(e) {
        var $target = $(e.target).find('option:selected');
        var name = $target.attr('data-name');
        var units = $target.attr('data-units');

        console.log("Searching for", $target, name, units);
        var history = $.get("http://104.131.168.178:3389/sql?query=select * from coop where name='" + name + "' and units='" + units + "' order by date asc");
        history.done(function(data) {
          prep(data, {
            title: name + ' ' + units,
            name: name,
            units: units
          });
        });
      });
    });
  });
</script>

</body>
</html>
